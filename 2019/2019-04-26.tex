%%% Research Diary - Entry
\documentclass[11pt,a4paper]{article}

% Working date: The date this entry is describing. Not necessary the date of last edit.
\newcommand{\workingDate}{\textsc{2019 $|$ April $|$ 26}}

% Name and institution must preceed call to researchdiary.sty package
\newcommand{\userName}{Pierre BrÃ©chet}
\newcommand{\institution}{TUM}

% The guts and glory
\usepackage{research_diary}
\usepackage{usrcmd}
\bibliography{bibliography}

% Begin document.
% Use \logoPNG or \logoEPS. If compiling with PDFTeX, use \logoPNG
\begin{document}
% \logoPNG

{\Huge April 26}

\section*{Using an extracting feature network}
One idea, already stated in \cite{Sanjabi2018,Genevay2017a}, is to use a
feature extraction network $F \from X \to X'$ in order to perform the OT in a
more ``representative`` space of features, $X'$.  The cost $c$ is composed with
$(F,F)$ to produce $c' = c \circ (F,F) \circ (G,\id)$.
% $c' \from X' \times X' \to \RR$ and can be for instance
% $c(z,y) = \cb(G(z),y) = c'(F(G(z)),F(y)) = \norm{F(G(z)) - F(y)}_1$. The
% network $F$ has to be fixed as is $G$ in the dual update.

This pre-composition is the dual operation of push-forward in the measure.

    \begin{align}
        &\min_{\gamma'}\set{\int_{X' \times X'}c(x', y') \d \gamma' (x',y') + \eps \R(\gamma) \st \gamma' \in \Gamma\paren{\pf{F}{\pf{G}{\zeta}},\pf{F}{\nu}}} & \\
        \iff &\min_{\gammab}\set{\int_{\XX}c(F(x), F(y)) \d \gammab (x,y) + \eps \R(\gamma) \st \gammab \in \Gamma\paren{\pf{G}{\zeta},\nu}}&  \gamma' = \pf{(F, F)}\gammab\\
        \iff &\min_{\gamma}\set{\int_{\ZX}c(F(G(z)), F(y)) \d \gamma (z,y) + \eps \R(\gamma) \st \gamma \in \Gamma(\zeta, \nu)}  &\gammab = \pf{(G, \id)}\gamma \label{eqn:extract-general-primal}
\end{align}
with $\Gamma(\mu, \nu) = \set{\gamma \in \Mpo(\XY) \st \pf{\proj{1}}\gamma = \mu,\, \pf{\proj{2}}{\gamma} = \nu}$ for $\mu \in \Mpo(X), \, \nu \in \Mpo(Y)$. \\

    Recall the primal expression of ROTGAN
\begin{align}
        &\min_{G}{\Wce(\pf{G}{\zeta}, \nu)} &\\
    % \min_{G} \min_{\gamma}{\set{\int_{\ZX}{c(x, y) \d \gamma(x, y)} \st \gamma \in \Gamma(\mu, \nu)}} & \\
    \iff&\min_{G} \min_{\gamma}{\set{\int_{\ZX}{c(G(z), y) \d \gamma}(z, y)  + \eps \R(\gamma) \st \gamma \in \Gamma(\zeta, \nu)}}\label{eqn:primal-objective-rotgan}\\
    \iff & \begin{array}{*2{>{\displaystyle}l}}
        \min_{G} \min_{\gamma \in \M(\ZX)} &\int_{\ZY}{c(G(z), y) \d \gamma}(z, y) + \delta_{+}\paren{\gamma} + \eps \R(\gamma) \\
            % &+ \delta\set{\pf{(\projX}{\pf{(G, \id)}{\gamma}} = \pf{G}{\zeta}, \pf{\projY}{\pf{(G, \id)}{\gamma}} = \nu)}
              &+ \delta_{\set{\pf{G}{\zeta}}}\paren{ \pf{( \proj{1} )}{\pf{\paren{G,\id}}{\gamma}} }  + \delta_{\set{\nu}}\paren{ \pf{(\proj{2})}{\pf{\paren{G, \id}}{\gamma}} }
            \end{array}
    \label{eqn:general-rotgan}
\end{align}
and its dual

\begin{equation}
    \label{eqn:dual-general-rotgan}
\begin{array}{*2{>{\displaystyle}l}}
    \max_{D_1, D_2} & \int_{Z} {D_1 \circ G(z) \d \zeta(z)} + \int_{X}{D_2(y) \d
        \nu(y)} \\
        & -
        % \left\{ \begin{array}{*2{>{\displaystyle}l}}
        \eps \int_{\ZY}{\exp{\paren{\frac{D_1 \circ G(z) + D_2(y) - c(G(z), y)}{\eps}}} \d \zetaxnu(z, y)} %&\text{if $\R = \Rent$} \\
    % \frac{1}{2\eps} \int_{\ZY}{ \posi{D_1 \circ G (z) + D_2(y) - c(G(z), y)}^2 \d \zetaxnu(z, y)} & \text{if $\R=\Rtwo$}
% \end{array} \right.
\\
        &\eqdef \L(D_1, D_2, G)

    \end{array}
\end{equation}

Using a feature extraction in the primal costs corresponds to solving
\begin{align}
        &\min_{G}{\Wce(\pf{F}{\pf{G}{\zeta}}, \pf{F}\nu)} &\\
    % \min_{G} \min_{\gamma}{\set{\int_{\ZX}{c(x, y) \d \gamma(x, y)} \st \gamma \in \Gamma(\mu, \nu)}} & \\
    \iff&\min_{G} \min_{\gamma}{\set{\int_{\ZX}{c(F(G(z)), F(y)) \d \gamma}(z, y)  + \eps \R(\gamma) \st \gamma \in \Gamma(\zeta, \nu)}}\label{eqn:primal-objective-rotgan}\\
    \iff & \begin{array}{*2{>{\displaystyle}l}}
        \min_{G} \min_{\gamma \in \M(\ZX)} &\int_{\ZY}{c(F(G(z)), F(y)) \d \gamma}(z, y) + \delta_{+}\paren{\gamma} + \eps \R(\gamma) \\
            % &+ \delta\set{\pf{(\projX}{\pf{(G, \id)}{\gamma}} = \pf{G}{\zeta}, \pf{\projY}{\pf{(G, \id)}{\gamma}} = \nu)}
              &+ \delta_{\set{\pf{F}\pf{G}{\zeta}}}\paren{ \pf{( \proj{1} )}{\pf{(F, F)}{\pf{\paren{G,\id}}{\gamma}}} }  + \delta_{\set{\pf{F}\nu}}\paren{ \pf{(\proj{2})}{\pf{(F, F)}\pf{\paren{G, \id}}{\gamma}}}
            \end{array}
    \label{eqn:general-feature-rotgan}
\end{align}

Therefore, the dual solutions for \eqref{eqn:general-feature-rotgan} are similarly expressed except pre-composed with $F$.
\begin{equation}
    \label{eqn:dual-general-rotgan}
\begin{array}{*2{>{\displaystyle}l}}
    \max_{D_1', D_2'} & \int_{Z} {D_1' \circ F \circ G(z) \d \zeta(z)} + \int_{X}{D_2' \circ F (y) \d
        \nu(y)} \\
        & -
        % \left\{ \begin{array}{*2{>{\displaystyle}l}}
        \eps \int_{\ZY}{\exp{\paren{\frac{D_1' \circ F \circ G(z) + D_2' \circ F(y) - c(F(G(z)), F(y))}{\eps}}} \d \zetaxnu(z, y)} %&\text{if $\R = \Rent$} \\
        % \frac{1}{2\eps} \int_{\ZY}{ \posi{D_1' \circ F \circ G (z) + D_2' \circ F(y) - c(F(G(z)), F(y))}^2 \d \zetaxnu(z, y)} & \text{if $\R=\Rtwo$}
% \end{array} \right.
\\
        &\eqdef \L(D_1', D_2', F, G)

    \end{array}
\end{equation}

This time, the dual networks $D_i', i\in \set{1,2}$ are functions mapping from $X'$ to $\RR$.

    % For a fixed $F$ the previous equation gives the dual solutions  \cite{Feydy2018}

\begin{rem}
    Each of the $D_i$ can be expressed with the shared layers $F$ and its
    specialized layers $D_i'$ as $D_i = D_i' \circ F, \quad i \in \set{1,2}$.
    The main difference with \eqref{eqn:dual-general-rotgan} is the presence of
    $F$ in the cost function.
\end{rem}

The primal-dual relationship is also modified accordingly
\begin{align}
    \label{eqn:primal-dual-rotgan}
    \radon{\gamma}{\zetaxnu}(z,y)
              &=
              % \left\{ \begin{array}{*2{>{\displaystyle}l}}
              \exp\paren{\frac{D_1' \circ F \circ G(z) + D_2' \circ F(y) - c(F(G(z)), F(y))}{\eps}} %& \text{if $\R = \Rent$}  \\
                  % \frac{\posi{D_1 \circ G(z) + D_2(y) - c(G(z), y)}}{2\eps} & \text{if $\R = \Rtwo$}
              % \end{array} \right.
\end{align}

The natural question is how to update the extraction network $F$. In \cite{Arjovsky2018}, the authors offers to make $F$ maximize the primal (unregularized) cost. This is motivated by aiming at having a discriminating $F$, i.e. maximizing the Wasserstein cost (which is convex?)

Another solution would be for $F$ to maximize the (concave) dual objective. The problem is that $F$ appears in the dual objective, in the regularization term.

\begin{equation}
%    & \min_{G}{\min_{\gamma \in \Gamma(\zeta, \nu)}{\set{\int_{\ZX}{c(G(z), y) \d \gamma(z, y)}  + \eps \R( \gamma )}}} \\
% \iff & \min_{G}{\max_{D_1, D_2}} \\
    \label{eqn:algo-rotgan}
    \tag{ROTGAN}
    \begin{array}{crc>{\displaystyle}ll}
        \circled{1} & D_1', D_2' & \assign & \argmax_{D_1', D_2'} \L(D_1', D_2', F, G) & \text{see \eqref{eqn:dual-general-rotgan}} \\
%         \begin{array}{*2{>{\displaystyle}l}}
%             \argmax_{D_1, D_2} &\int_{Z}{D_1 \circ G(z) \d \zeta(z)} + \int_{X}{D_2(y) \d \nu(y)} \\
%                                &- \left\{
%     \begin{array}{*2{>{\displaystyle}l}}
%         \eps \int_{\ZY}{\exp{\paren{\frac{D_1 \circ G(z) + D_2(y) - c(G(z), y)}{\eps}}} \d \zetaxnu(z, y)} &\text{if $\R = \Rent$} \\
%     \frac{1}{2\eps} \int_{\ZY}{ \posi{D_1 \circ G (z) + D_2(y) - c(G(z), y)}^2 \d \zetaxnu(z, y)} & \text{if $\R=\Rtwo$}
% \end{array} \right.        \end{array}\\
\circled{2} & \d \gamma(z,y) & = & \radon{\gamma}{\zetaxnu}(z,y) \d \zetaxnu(z,y) & \text{see \eqref{eqn:primal-dual-rotgan}}\\%& \text{Primal-dual optimality}\\
\circled{3} & G & \assign & \argmin_{G}{\int_{\ZX}{c(F(G(z)), F(y)) \d \gamma(z, y)}}\\% &\text{Generator update}\\
\circled{4} & F & \assign & \argmax_{F}{\int_{\ZX}{c(F(G(z)), F(y)) \d \gamma(z, y)}}\\% &\text{Generator update}\\
\end{array}
\end{equation}

\section*{Sinkhorn loss}
The sinkhorn loss is based on the Wasserstein loss $\Wce$:
\begin{equation}
    \SL(\alpha, \beta) = 2 \Wce(\alpha, \beta) - \Wce(\alpha, \alpha) - \Wce(\beta, \beta)
\end{equation}

The Sinkhorn ROTGAN is defined on the sinkhorn primal loss
\begin{align}
    &\min_{G} \SL(\pf{G}{\zeta}, \nu)  \\
    \iff & \min_{G} 2 \Wce(\pf{G}{\zeta}, \nu) - \Wce(\pf{G}{\zeta}, \pf{G}{\zeta}) - \Wce(\nu, \nu)
\end{align}

Using the extraction feature would correspond to solving
\begin{align}
    &\max_{F} \min_{G} \SL(\pf{F}{\pf{G}{\zeta}}, \pf{F}{\nu}) \\
    \iff & \max_{F} \min_{G} 2 \Wce(\pf{F}{\pf{G}{\zeta}}, \pf{F}{\nu}) - \Wce(\pf{F}{\pf{G}{\zeta}}, \pf{F}{\pf{G}{\zeta}}) - \Wce(\pf{F}{\nu}, \pf{F}{\nu})
\end{align}

\printbibliography{}
\end{document}
